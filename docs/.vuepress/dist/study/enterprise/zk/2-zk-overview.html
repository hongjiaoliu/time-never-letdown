<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://liuhongjiao.cn/study/enterprise/zk/2-zk-overview.html"><meta property="og:site_name" content="L - 时光不负"><meta property="og:title" content="Zookeeper详细教程"><meta property="og:description" content="Zookeeper详细教程 转自：https://gitee.com/yooome/golang/blob/main/Zookeeper详细教程/Zookeeper详细教程-data01.md#"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-04-10T02:23:05.000Z"><meta property="article:tag" content="ZK"><meta property="article:published_time" content="2023-04-10T00:00:00.000Z"><meta property="article:modified_time" content="2023-04-10T02:23:05.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Zookeeper详细教程","image":[""],"datePublished":"2023-04-10T00:00:00.000Z","dateModified":"2023-04-10T02:23:05.000Z","author":[]}</script><meta name="baidu_union_verify" content="0b1f86cf9f95a06866dba08d15b9504d"><title>Zookeeper详细教程 | L - 时光不负</title><meta name="description" content="Zookeeper详细教程 转自：https://gitee.com/yooome/golang/blob/main/Zookeeper详细教程/Zookeeper详细教程-data01.md#">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-8f77a4da.css" as="style"><link rel="stylesheet" href="/assets/style-8f77a4da.css">
    <link rel="modulepreload" href="/assets/app-5f172635.js"><link rel="modulepreload" href="/assets/framework-bcbeea85.js"><link rel="modulepreload" href="/assets/2-zk-overview.html-4fe555b1.js"><link rel="modulepreload" href="/assets/2-zk-overview.html-6fedae6d.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="L - 时光不负"><!----><span class="site-name hide-in-pad">L - 时光不负</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="博客首页"><span class="font-icon icon iconfont icon-home" style=""></span>博客首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/pw/" class="nav-link" aria-label="个人建站"><span class="font-icon icon iconfont icon-discover" style=""></span>个人建站<!----></a></div><div class="nav-item hide-in-mobile"><a href="/study/" class="nav-link active" aria-label="聚水成川"><span class="font-icon icon iconfont icon-note" style=""></span>聚水成川<!----></a></div><div class="nav-item hide-in-mobile"><a href="/pits/" class="nav-link" aria-label="踩坑系列"><span class="font-icon icon iconfont icon-edit" style=""></span>踩坑系列<!----></a></div><div class="nav-item hide-in-mobile"><a href="/essay/" class="nav-link" aria-label="随记日常"><span class="font-icon icon iconfont icon-note" style=""></span>随记日常<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/study/" class="nav-link sidebar-link sidebar-page" aria-label="Study"><!---->Study<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">一、Core-Java</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-advance" style=""></span><span class="title">二、Java企业级开发</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.1、Spring</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.2、SpringMVC</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.3、SpringBoot</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.4、Dubbo</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.5、Nginx</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.6、ElasticSearch</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.7、ZooKeeper</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/study/enterprise/zk/1-install-in-mac.html" class="nav-link sidebar-link sidebar-page" aria-label="1-Mac安装"><span class="font-icon icon iconfont icon-edit" style=""></span>1-Mac安装<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/study/enterprise/zk/2-zk-overview.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Zookeeper详细教程"><span class="font-icon icon iconfont icon-edit" style=""></span>Zookeeper详细教程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.8、Docker</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.9、K8S</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">2.10、Mybatis</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="title">三、数据库</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-structure" style=""></span><span class="title">四、通用技能</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-more" style=""></span><span class="title">五、扩展系列</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-more" style=""></span><span class="title">六、提效工具</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-discover" style=""></span><span class="title">踩坑系列</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="font-icon icon iconfont icon-edit" style=""></span>Zookeeper详细教程</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://liuhongjiao.cn" target="_blank" rel="noopener noreferrer">哇哩哇哩哇</a></span><span property="author" content="哇哩哇哩哇"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-04-10T00:00:00.000Z"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category7 clickable" role="navigation">Java企业开发</span><meta property="articleSection" content="Java企业开发"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag0 clickable" role="navigation">ZK</span><meta property="keywords" content="ZK"></span><span class="page-word-info" aria-label="字数🔠" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 11134 字</span><meta property="wordCount" content="11134"></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 37 分钟</span><meta property="timeRequired" content="PT37M"></span></div><hr></div><!----><!----><div class="theme-hope-content"><h1 id="zookeeper详细教程" tabindex="-1"><a class="header-anchor" href="#zookeeper详细教程" aria-hidden="true">#</a> Zookeeper详细教程</h1><blockquote><p>转自：<a href="https://gitee.com/yooome/golang/blob/main/Zookeeper%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/Zookeeper%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B-data01.md#" target="_blank" rel="noopener noreferrer">https://gitee.com/yooome/golang/blob/main/Zookeeper详细教程/Zookeeper详细教程-data01.md#<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h4 id="一、zookeeper介绍" tabindex="-1"><a class="header-anchor" href="#一、zookeeper介绍" aria-hidden="true">#</a> 一、Zookeeper介绍</h4><h5 id="_1-1-什么是zookeeper" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是zookeeper" aria-hidden="true">#</a> 1.1 什么是zookeeper</h5><p>​ Zookeeper是一个分布式的、高性能的、开源的分布式系统的协调（Coordination）服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的一个重要的组件。它是一个为分布式应用提供一致性服务的软件。</p><h5 id="_1-2-zookeeper应用场景" tabindex="-1"><a class="header-anchor" href="#_1-2-zookeeper应用场景" aria-hidden="true">#</a> 1.2 zookeeper应用场景</h5><p>​ zookeeper是一个经典的分布式数据一致性解决方案，致力于为分布式应用提供一个高性能，高可用，且具有严格属性访问控制能力的分布式协调存储服务。</p><ul><li>维护配置信息</li><li>分布式锁服务</li><li>集群管理</li><li>生成分布式唯一ID</li></ul><p><strong>1、维护配置信息</strong></p><p>​ java编程经常会遇到配置项，比如数据库的url，schema，user和password等。通常这些配置项我们会放置在配置文件中，在将配置文件放置在服务器上当需要更改配置的时，需要去服务器上修改对应的配置信息文件。但是随着分布式系统的兴起，由于许多服务都需要使用到该配置文件，因此有必须保证该配置服务的高可用性和各台服务器上配置数据的一致性。通常会将配置文件不俗在一个集群上，然而一个集群动辄上前台服务器，此时如果在一台一台服务器逐个的修改配置文件将是非常繁琐的一个操作。因此就需要一种服务，能够高效快速且可靠的完成配置项的更待等操作，并能够保证各个配置项在每一台服务器上的数据一致性。</p><p>​ zookeeper就可以提供这样一种服务，其使用Zab这种一致性协议来保证一致性。现在有很多开源项目使用zookeeper来维护配置，比如hhase中，客户端就是连接一个zookeeper，获得必要hbase集群的配置信息然后才可以进一步操作。还有开源的消息队列kafka中，也是用zookeeper来维护broker的信息。</p><p><strong>2、分布式锁服务</strong></p><p>​ 一个集群是一个分布式系统，有多台服务器组成。为了提高并发度和可靠性，多台服务器运行着同一种服务。当多个服务在运行时就需要协调各服务的进度，有时候需要保证当某个服务在进行某个操作时，其他的服务都不能进行该操作，即对该操作进行加锁，如果当前机器挂掉后，并释放fail over到其他的机器继续执行该服务。</p><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092656228.png" alt="图 1" tabindex="0" loading="lazy"><figcaption>图 1</figcaption></figure><p><strong>3、集群管理</strong></p><p>​ 一个集群优势会因为各种软硬件故障或者网络故障，出现某种服务器挂掉而被移除集群，而某些服务器加入到集群中的情况，zookeeper会将这些服务器加入/移出的情况下通知给集群汇总的其他正常工作的服务器，以及时调用存储和计算等任务的分配和执行等。此外zookeeper还会对故障的服务器做出诊断并尝试修复。</p><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092679758.png" alt="图 2" tabindex="0" loading="lazy"><figcaption>图 2</figcaption></figure><p><strong>4、生成分布式唯一ID</strong></p><p>​ 在过去的单库单表型系统中，通常可以使用数据库字段自带的auto_increment属性来自动为每条记录生成一个唯一的ID。但是分库分表后，就无法再依靠数据库的auto_increatment属性来唯一标识一条记录了，此时我们就可以用zookeeper在分布式环境下生成全局唯一ID。做法如下：每一个生成一个新ID时，创建一个持久顺序节点，创建操作返回的节点序号，及微信ID，然后把比自己节点小的删除即可。</p><h5 id="_1-3-zookeeper的设计目标" tabindex="-1"><a class="header-anchor" href="#_1-3-zookeeper的设计目标" aria-hidden="true">#</a> 1.3 zookeeper的设计目标</h5><p>​ zookeeper致力于为分布式应用提供一个高性能，高可用，具有严格顺序访问控制能力的分布式协调服务。</p><p><strong>1、高性能</strong></p><p>​ zookeeper将全量数据存储在内存中，并直接服务与客户端的所有非事务请求，尤其适合用于以读为主的应用场景。</p><p><strong>2、高可用</strong></p><p>​ zookeeper一般以集群的范式对外提供服务，一般3-5台机器就可以组成一个可用的zookeeper集群，每一台机器都会在内存中维护当前的服务器状态，并且每台机器之间都相互保持着通信。只要集群中超过一旦的机器都在工作，那么这个集群就能够正常对外服务；</p><p><strong>3、严格访问数据</strong></p><p>​ 对于客户端的每一个更新请求，Zookeeper都会分配一个全局唯一的递增编号，这个编号反映了所有事物操作的先后顺序。</p><h4 id="二、zookeeper的数据模型" tabindex="-1"><a class="header-anchor" href="#二、zookeeper的数据模型" aria-hidden="true">#</a> 二、Zookeeper的数据模型</h4><h5 id="_2-1-zookeeper数据结构" tabindex="-1"><a class="header-anchor" href="#_2-1-zookeeper数据结构" aria-hidden="true">#</a> 2.1 zookeeper数据结构</h5><pre><code>Zookeeper数据模型的结构与Unix文件系统很类似，整体上可以看作是一颗树，每一个节点称做一个ZNode。每一个Znode默认能够存储1MB的数据，每个ZNode都可以通过其路径唯一标识。
</code></pre><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092703384.png" alt="图 3" tabindex="0" loading="lazy"><figcaption>图 3</figcaption></figure><p>如何来描述一个ZNode呢？一个znode大体上分为3部分：</p><ul><li>节点的数据：即znode data(节点path，节点data的关系)就像是java map中(key，value)的关系</li><li>节点的子节点children</li><li>节点的状态stat：用来描述当前节点的创建，修改记录，包括cZxid、ctime等。</li></ul><h5 id="_2-2-zookeeper节点类型" tabindex="-1"><a class="header-anchor" href="#_2-2-zookeeper节点类型" aria-hidden="true">#</a> 2.2 zookeeper节点类型</h5><p>​ zookeeper中的节点有两种类型，一种是<strong>临时节点</strong>和<strong>永久节点</strong>。节点类型在创建是即被确定，并且不能改变。</p><ul><li><strong>临时节点</strong> ：该节点的生命周期依赖于创建他们的回话。一旦回话（Session）结束，临时节点将会被自动删除，当然可以手动的进行删除。虽然每个临时的ZNode都会绑定到一个客户端回话，但他们对所有的客户端还是可见的。另外，Zookeeper的临时节点不允许拥有子节点。</li><li><strong>持久化节点</strong>：该节点的生命周期不依赖于花花，并且只有在客户点显示执行删除操作的时候，他们才能被删除。</li></ul><h5 id="_2-3-zookeeper-单机安装" tabindex="-1"><a class="header-anchor" href="#_2-3-zookeeper-单机安装" aria-hidden="true">#</a> 2.3 zookeeper 单机安装</h5><p>​ 当前测试系统环境centos7.3</p><p>1.在centos中使用root用户创建zookeeper用户，用户名：zookeeper 密码：zookeeper</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>useradd zookeeper
passwd zookeeper
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>zookeeper 底层依赖jdk，zookeeper用户登录后，根目录下先进行jdk的安装，jdk使用jdk-11.0.5</li></ol><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code>//解压jdk
tar -xzvf jdk-11.0.5.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>3.配置jdk环境量</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>//打开/etc/profile文件
# vim /etc/profile
export JAVA_HOME=/root/apps/jdk-11.0.5
export PATH=$PATH:$JAVA_HOME/bin
//执行profile
#source /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.zookeeper使用zookeeper-3.4.10.tar.gz,上传并解压</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//解压zookeeper
tar -xzvf zookeeper-3.4.10.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>5.为zookeeper准备配置文件</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//进入conf目录
cd /root/apps/zookeeper/zookeeper-3.4.14/conf
//复制配置文件
cp zoo_sample.cfg zoo.cfg
//zookeeper根目录下新建data目录
mkdir data
// vi 修改配置文件中的dataDir
// 此路径用于存储zookeeper中数据的内存快照，及事务日志文件
dataDir=/root/apps/zookeeper/zookeeper-3.4.14/data
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092727262.png" alt="图 4" tabindex="0" loading="lazy"><figcaption>图 4</figcaption></figure><p>6.zookeeper启动命令</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[root@centos ~]# systemctl stop firewalld #关闭防火墙的命令
[root@centos ~]# zkServer.sh start  #启动
[root@centos ~]# zkServer.sh stop   #关闭
[root@centos ~]# zkServer.sh status #查看运行状态

启动客户端：
[root@localhost ~]# zkCli.sh   //启动客户端
[zk: localhost:2181(CONNECTED) 0] ls /  #查看根节点命令
//查看zookeeper进程是否存在
[root@centos zookeeper-3.4.14]# ps -ef | grep zookeeper
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="三、zookeeper常用的shell命令" tabindex="-1"><a class="header-anchor" href="#三、zookeeper常用的shell命令" aria-hidden="true">#</a> 三、zookeeper常用的Shell命令</h4><h5 id="_3-1-新增节点" tabindex="-1"><a class="header-anchor" href="#_3-1-新增节点" aria-hidden="true">#</a> 3.1 新增节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>create [-s] [-e] path data   # 其中 -s 为有序节点， -e 临时节点
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>1.创建持久化节点并写入数据：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>create /hadoop  &quot;123456&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>2.创建持久化有序节，此时创建的节点名为指定节点名+自增序号</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//创建一个持久化节点
[zk: localhost:2181(CONNECTED) 1] create /hadoop &quot;123456&quot;
//通过get命令获取该节点的值
[zk: localhost:2181(CONNECTED) 2] get /hadoop
//创建一个有序的节点
[zk: localhost:2181(CONNECTED) 4] create -s /a &quot;aa&quot;
Created /a0000000001
//获取路径的值
[zk: localhost:2181(CONNECTED) 5] get /a0000000001
aa

//创建临时节点并获取值
[zk: localhost:2181(CONNECTED) 1] create -e /tmp &quot;tmp&quot;
Created /tmp
[zk: localhost:2181(CONNECTED) 2] get /tmp
tmp
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092748453.png" alt="图 5" tabindex="0" loading="lazy"><figcaption>图 5</figcaption></figure><p>3.创建临时节点，临时节点会在回话过期后被删除;</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[zk: localhost:2181(CONNECTED) 1] create -e /tmp &quot;tmp&quot;
Created /tmp

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.创建临时有序节点，临时节点会在会话过期后被删除：</p><pre><code>```xml
</code></pre><p>[zk: localhost:2181(CONNECTED) 1] create -s -e /tmp &quot;tmp&quot; Created /tmp000000001 ```</p><h5 id="_3-2-更新节点" tabindex="-1"><a class="header-anchor" href="#_3-2-更新节点" aria-hidden="true">#</a> 3.2 更新节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//使用set命令来更新hadoop节点
[zk: localhost:2181(CONNECTED) 1] set /hadoop &quot;345&quot;
//根据版本号来更新节点
[zk: localhost:2181(CONNECTED) 1] set /hadoop &quot;345&quot; 2

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 也可以基于版本号来进行更改，此时类似于乐观锁机制，当你传入的数据版本号(dataVersion)和当前节点的数据版本号不符合时，zookeeper会拒绝本次修改：</p><h5 id="_3-3-删除节点" tabindex="-1"><a class="header-anchor" href="#_3-3-删除节点" aria-hidden="true">#</a> 3.3 删除节点</h5><p>1.删除节点的命令如下</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>delete path [version]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>和更新节点数据一样，也可以传入版本号，当你传入的数据版本号(dataVersion)和当前节点的数据版本号不符合时，zookeeper不会执行删除操作。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//根据版本号来删除节点
[zk: localhost:2181(CONNECTED) 1] set /hadoop &quot;345&quot; 2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>要想删除某个节点及其所有后代节点，可以使用递归删除，<strong>命令为 rmr path</strong>。</p><h5 id="_3-4-查看节点" tabindex="-1"><a class="header-anchor" href="#_3-4-查看节点" aria-hidden="true">#</a> 3.4 查看节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>get path 
[zk: localhost:2181(CONNECTED) 1] get /hadoop 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[zk: localhost:2181(CONNECTED) 0] create /hadoop2 &quot;hadoop&quot;
Created /hadoop2
[zk: localhost:2181(CONNECTED) 1] get /hadoop2
hadoop
cZxid = 0xb
ctime = Thu May 14 09:06:29 CST 2020
mZxid = 0xb
mtime = Thu May 14 09:06:29 CST 2020
pZxid = 0xb
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 6
numChildren = 0
[zk: localhost:2181(CONNECTED) 2]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 节点各个属性如下表。起哄一个重要的概念是Zxid(ZooKeeper Transaction Id)，ZooKeeper节点的每一个更改都具唯一的Zxid，如果Zxid1小于Zxid2,则Zxid1的更改发生在Zxid2更改之前。</p><table><thead><tr><th>状态属性</th><th>节点说明</th></tr></thead><tbody><tr><td>cZxid</td><td>数据节点创建时的事务ID</td></tr><tr><td>ctime</td><td>数据节点创建世的时间</td></tr><tr><td>mZxid</td><td>数据节点最后一个更新是的事务ID</td></tr><tr><td>mtime</td><td>数据节点最后一个跟新时的时间</td></tr><tr><td>pZxid</td><td>数据节点的子节点最后一个被修改时的事务ID</td></tr><tr><td>cversion</td><td>子节点的更改次数</td></tr><tr><td>dataVerion</td><td>节点数据的更改次数</td></tr><tr><td>aclVersion</td><td>节点ACL的更改次数</td></tr><tr><td>ephemeralOwner</td><td>如果节点是临时节点，则表示创建该节点的会话的SeeesionID;如果是持久节点，则该属性值为0</td></tr><tr><td>dataLength</td><td>数据内容的长度</td></tr><tr><td>numChildren</td><td>数据节点当前的子节点个数</td></tr></tbody></table><h5 id="_3-5-查看节点状态" tabindex="-1"><a class="header-anchor" href="#_3-5-查看节点状态" aria-hidden="true">#</a> 3.5 查看节点状态</h5><p>​ 可以使用stat命令查看节点状态，它的返回值和get命令类似，但不会返回节点数据</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//使用stat命令来查看节点状态
[zk: localhost:2181(CONNECTED) 0] stat /hadoop
cZxid = 0x4
ctime = Thu May 14 07:56:33 CST 2020
mZxid = 0x4
mtime = Thu May 14 07:56:33 CST 2020
pZxid = 0x4
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 6
numChildren = 0
[zk: localhost:2181(CONNECTED) 1]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-6-查看节点列表" tabindex="-1"><a class="header-anchor" href="#_3-6-查看节点列表" aria-hidden="true">#</a> 3.6 查看节点列表</h5><p>​ 查看节点列表有ls path 和ls2 path 两个命令，后者是前者的增强。不仅可以查看指定路径下的所有节点，还可以查看当前几点的信息</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[zk: localhost:2181(CONNECTED) 5] ls /
[a0000000001, hadoop, zookeeper, tmp, hadoop2]
[zk: localhost:2181(CONNECTED) 6] ls2 /
[a0000000001, hadoop, zookeeper, tmp, hadoop2]
cZxid = 0x0
ctime = Thu Jan 01 08:00:00 CST 1970
mZxid = 0x0
mtime = Thu Jan 01 08:00:00 CST 1970
pZxid = 0xb
cversion = 3
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 0
numChildren = 5
[zk: localhost:2181(CONNECTED) 7] 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-7-监听器get-path-watch" tabindex="-1"><a class="header-anchor" href="#_3-7-监听器get-path-watch" aria-hidden="true">#</a> 3.7 监听器get path [watch]</h5><p>​ 使用get path [watch] 注册的监听器能够在节点内容发生改变的时候，向客户点发出通知。需要注意的是zookeeper的触发器是一次性的(One-time trigger)，触发一次后就会立即失效。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[zk: localhost:2181(CONNECTED) 8] get /hadoop watch
123456
cZxid = 0x4
ctime = Thu May 14 07:56:33 CST 2020
mZxid = 0x4
mtime = Thu May 14 07:56:33 CST 2020
pZxid = 0x4
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 6
numChildren = 0
[zk: localhost:2181(CONNECTED) 9] 
WATCHER::

WatchedEvent state:SyncConnected type:NodeDataChanged path:/hadoop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-8-监听器stat-path-watch" tabindex="-1"><a class="header-anchor" href="#_3-8-监听器stat-path-watch" aria-hidden="true">#</a> 3.8 监听器stat path [watch]</h5><p>​ 使用stat path [watch] 注册的监听器能够在节点抓哪个台发生改变的时候，向客户点发出通知。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[zk: localhost:2181(CONNECTED) 1] stat /hadoop watch
cZxid = 0x4
ctime = Thu May 14 07:56:33 CST 2020
mZxid = 0xf
mtime = Thu May 14 10:01:04 CST 2020
pZxid = 0x4
cversion = 0
dataVersion = 1
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 6
numChildren = 0
[zk: localhost:2181(CONNECTED) 2] 
WATCHER::

WatchedEvent state:SyncConnected type:NodeDataChanged path:/hadoop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-9-监听器ls-ls2-path-watch" tabindex="-1"><a class="header-anchor" href="#_4-9-监听器ls-ls2-path-watch" aria-hidden="true">#</a> 4.9 监听器ls\ls2 path [watch]</h5><p>​ 使用 ls path [watch] 或者 ls2 path [watch] 注册的监听器能够监听该节点下所有子节点的增加和删除操作。</p><h4 id="四、zookeeper权限控制" tabindex="-1"><a class="header-anchor" href="#四、zookeeper权限控制" aria-hidden="true">#</a> 四、zookeeper权限控制</h4><h5 id="_4-1-概述" tabindex="-1"><a class="header-anchor" href="#_4-1-概述" aria-hidden="true">#</a> 4.1 概述</h5><p>​ zookeeper类似于文件系统，client可以创建节点，更新节点，删除节点，那么如何做到节点的权限的控制呢？zookeeper的access control list 访问控制列表可以自耦到这一点。</p><p>​ acl权限控制，使用scheme：id：permission来表示，主要涵盖3个方面：</p><ul><li><p>权限模式(scheme)：授权的策略</p></li><li><p>授权对象(id)：授权的对象</p></li><li><p>权限(permission)：授予的权限</p><p><strong>其特性如下：</strong></p></li><li><p>zookeeper的权限控制是基于每个znode节点的，需要对每个节点设置权限</p></li><li><p>每个znode支持设置多种权限控制方案和多个权限</p></li><li><p>子节点不会继承父节点的权限，客户点无权访问某个节点，但可能可以访问他的子节点</p></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>setAcl <span class="token operator">/</span>test2 ip<span class="token operator">:</span><span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span>rewda <span class="token comment">//将节点权限设置为Ip:192.168.60.130的客户端可以对节点进行增、删、该、查、权限管理</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_4-2-权限模式" tabindex="-1"><a class="header-anchor" href="#_4-2-权限模式" aria-hidden="true">#</a> 4.2 权限模式</h5><p>​ 采用何种方式授权</p><table><thead><tr><th style="text-align:left;">方案</th><th>描述</th></tr></thead><tbody><tr><td style="text-align:left;">world</td><td>只有一个用户：anyone，代表登录zooleeper所有人（默认）</td></tr><tr><td style="text-align:left;">ip</td><td>对客户端使用ip地址认证</td></tr><tr><td style="text-align:left;">auth</td><td>使用已添加认证的用户认证</td></tr><tr><td style="text-align:left;">digest</td><td>使用“用户名：密码”方式认证</td></tr></tbody></table><h5 id="_4-3-授权的对象" tabindex="-1"><a class="header-anchor" href="#_4-3-授权的对象" aria-hidden="true">#</a> 4.3 授权的对象</h5><p>​ 给谁授权</p><p>​ 授权对象ID是指，权限赋予的实体例如：ip地址或用户。</p><h5 id="_4-4-授予的权限" tabindex="-1"><a class="header-anchor" href="#_4-4-授予的权限" aria-hidden="true">#</a> 4.4 授予的权限</h5><p>​ 授予什么权限</p><p>​ create、delete、read、writer、admin也就是增、删、改、查、管理权限，这5中权限简写为cdrwa、注意：这5中权限中，delete是指对子节点的删除权限，其他4种权限值对自身节点的权限操作。</p><table><thead><tr><th>权限</th><th>ACL简写</th><th>描述</th></tr></thead><tbody><tr><td>create</td><td>c</td><td>可以创建子节点</td></tr><tr><td>delete</td><td>d</td><td>可以删除子节点(仅下一级节点)</td></tr><tr><td>read</td><td>r</td><td>可以读取节点数据及显示子节点列表</td></tr><tr><td>write</td><td>w</td><td>可以设置节点数据</td></tr><tr><td>admin</td><td>a</td><td>可以设置节点访问控制列表权限</td></tr></tbody></table><h5 id="_4-5-授权的相关命令" tabindex="-1"><a class="header-anchor" href="#_4-5-授权的相关命令" aria-hidden="true">#</a> 4.5 授权的相关命令</h5><table><thead><tr><th>命令</th><th>使用方式</th><th>描述</th></tr></thead><tbody><tr><td>getAcl</td><td>getAcl</td><td>读取ACL权限</td></tr><tr><td>setAcl</td><td>setAcl</td><td>设置ACL权限</td></tr><tr><td>addauth</td><td>addauth</td><td>添加认证用户</td></tr></tbody></table><h5 id="_4-6-案例" tabindex="-1"><a class="header-anchor" href="#_4-6-案例" aria-hidden="true">#</a> 4.6 案例</h5><ul><li><p>world授权模式：</p><p>命令</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>setAcl <span class="token generics"><span class="token punctuation">&lt;</span>path<span class="token punctuation">&gt;</span></span> world<span class="token operator">:</span>anyone<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span>acl<span class="token punctuation">&gt;</span></span>
setAcl <span class="token operator">/</span>hadoop world<span class="token operator">:</span>anyone<span class="token operator">:</span>cdrwa
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>案例</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[zk: localhost:2181(CONNECTED) 2] getAcl /hadoop
&#39;world,&#39;anyone   #world方式对所有用户进行授权
: cdrwa          #增、删、改、查、管理
[zk: localhost:2181(CONNECTED) 3] 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>IP 授权模式</p><p>命令</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>#需要两台机器来进行连接 <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.129</span>  <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span> 
#使用 <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.129</span>  登录zookeeper
zkCli<span class="token punctuation">.</span>sh <span class="token operator">-</span>server <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span>
#使用本机  <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span> zookeeper
zkCli<span class="token punctuation">.</span>sh <span class="token operator">-</span>server <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Auth授权模式</p><p>命令</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>addauth digest <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span> #添加认证用户
setAcl <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span><span class="token punctuation">&gt;</span></span>auth:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>acl</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>案例</p></li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[zk: localhost:2181(CONNECTED) 0] create /hadoop3 &quot;hadoop3&quot;
Created /hadoop3
[zk: localhost:2181(CONNECTED) 1] getAcl /hadoop3
&#39;world,&#39;anyone
: cdrwa
[zk: localhost:2181(CONNECTED) 2] addauth digest tyx:123
[zk: localhost:2181(CONNECTED) 3] setAcl /hadoop3 auth:tyx:cdrwa
cZxid = 0x16
ctime = Thu May 14 20:29:34 CST 2020
mZxid = 0x16
mtime = Thu May 14 20:29:34 CST 2020
pZxid = 0x16
cversion = 0
dataVersion = 0
aclVersion = 1
ephemeralOwner = 0x0
dataLength = 7
numChildren = 0
[zk: localhost:2181(CONNECTED) 7] getAcl /hadoop3
&#39;digest,&#39;tyx:nSk0WYb+XoISHNhIQiQ1BGsZHjE=
: cdrwa
[zk: localhost:2181(CONNECTED) 8]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>Digest 授权模式</p><p>命令</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>setAcl <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span><span class="token punctuation">&gt;</span></span> digest:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>acl</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里的密码是经过SHA1及BASE64处理的密文，在SHEEL中可以通过命令计算：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>echo -n <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span> | openssl dgst -binary -sha1 | openssl base64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>先来计算一个密文</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>echo -n tyx:123 | openssl dgst -binary -sha1 | openssl base64
#得到的密文
[root@centos zookeeper-3.4.14]# echo -n tyx:123 | openssl dgst -binary -sha1 | openssl base64
nSk0WYb+XoISHNhIQiQ1BGsZHjE=
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>案例：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
[zk: localhost:2181(CONNECTED) 8] create /hadoop4 &quot;hadoop4&quot;
Created /hadoop4
[zk: localhost:2181(CONNECTED) 10] getAcl /hadoop4
&#39;world,&#39;anyone
: cdrwa
//使用digest进行授权
[zk: localhost:2181(CONNECTED) 11] setAcl /hadoop4 digest:tyx:nSk0WYb+XoISHNhIQiQ1BGsZHjE=:cdrwa

//该节点的权限
[zk: localhost:2181(CONNECTED) 13] getAcl /hadoop4
&#39;digest,&#39;tyx:nSk0WYb+XoISHNhIQiQ1BGsZHjE=
: cdrwa
//没有权限
[zk: localhost:2181(CONNECTED) 0] get /hadoop4
Authentication is not valid : /hadoop4
//添加授权用户
[zk: localhost:2181(CONNECTED) 1] addauth digest tyx:123
[zk: localhost:2181(CONNECTED) 2] get /hadoop4
hadoop4
cZxid = 0x19
ctime = Thu May 14 21:12:46 CST 2020
mZxid = 0x19
mtime = Thu May 14 21:12:46 CST 2020
pZxid = 0x19
cversion = 0
dataVersion = 0
aclVersion = 1
ephemeralOwner = 0x0
dataLength = 7
numChildren = 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>多种密室授权：</p><p>同一个节点可以同时使用多种模式授权</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>[zk: localhost:2181(CONNECTED) 8] create /hadoop4 &quot;hadoop4&quot;
Created /hadoop4
//添加认证用户
[zk: localhost:2181(CONNECTED) 8] addauth digest itcast:123456
[zk: localhost:2181(CONNECTED) 8] setAcl /hadoop4 ip:192.168.60.129:cdrwa,auth:tyx:123:cdrwa,digest:tyx:nSk0WYb+XoISHNhIQiQ1BGsZHjE=:cdrwa
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h5 id="_4-7-acl-超级管理员" tabindex="-1"><a class="header-anchor" href="#_4-7-acl-超级管理员" aria-hidden="true">#</a> 4.7 acl 超级管理员</h5><p>zookeeper的权限管理模式有一种叫做super，该模式提供一个超管，可以方阿斌的访问任何权限的节点</p><p>假设这个超管是：super：admin，需要先为超管生成密码的密文</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>echo -n super:admin | openssl dgst -binary -sha1 | openssl base64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>那么打开zookeeper目录下的/bin/zkServer.sh 服务器脚本，找到如下一行：</p><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681093240884.png" alt="图 11" tabindex="0" loading="lazy"><figcaption>图 11</figcaption></figure><p>之后启动zookeeper，输入如下的命令添加权限</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>addauth digest super:admin  #添加认证用户
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="五、zookeeper-javaapi" tabindex="-1"><a class="header-anchor" href="#五、zookeeper-javaapi" aria-hidden="true">#</a> 五、zookeeper javaAPI</h4><p>​ znode是zookeeper集合的核心组件，zookeeper API提供了一小组方法使用zookeeper集合来操作znode所有的细节。</p><p>客户端用该遵循以下步骤，与zookeeper服务器进行清洗和干净的交互。</p><ul><li>连接到zookeeper服务器。zookeeper服务器为客户端分配回话ID。</li><li>定期向服务器发送心跳。否则，zookeeper服务器将过期回话ID，客户端需要重新连接。</li><li>只要回话ID处于活动状态，就可以获取/设置znode。</li><li>所有任务完成后，断开与zookeeper服务器的连接。如果客户端长时间不活动，则zookeeper服务器将自动断开客户端。</li></ul><h5 id="_5-1-连接到zookeeper" tabindex="-1"><a class="header-anchor" href="#_5-1-连接到zookeeper" aria-hidden="true">#</a> 5.1 连接到zookeeper</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>Zookeeper(String connectionString,int sessionTimeout,Watcher watcher)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>connectionString -zookeeper 主机</li><li>sessionTimeout - 回话超时（一毫秒为单位）</li><li>watcher -实现“监视器”对象。zookeeper集合通过监视器对象返回连接状态。</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">WatchedEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">Watcher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">ZooKeeper</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> papi
 * <span class="token keyword">@data</span> 2020/5/1
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//arg1：服务器和端口号</span>
            <span class="token comment">//arg2: 客户端和服务器之间的会话超时时间</span>
            <span class="token comment">//arg3: 监视器对象</span>
            <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.90.108:2181&quot;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>watchedEvent<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;连接成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//通知主线不要去等待了</span>
                        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//主线程阻塞等待连接对象</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取zookeeper的session会话编号</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zooKeeper<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-新增节点" tabindex="-1"><a class="header-anchor" href="#_5-2-新增节点" aria-hidden="true">#</a> 5.2 新增节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//同步方式
create(String path, byte[] data, List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Acl</span><span class="token punctuation">&gt;</span></span> acl, CreateMode createMode)
//异步方式
create(String path, byte[] data, List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Acl</span><span class="token punctuation">&gt;</span></span> acl, CreateMode createMode, AsyncCallback.StringCallback callBack,Object ctx)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>path</strong> -znode路径。例如，/node1 /node1/node11</li><li><strong>data</strong> -要存储的指定znode路径中的数据</li><li><strong>acl</strong> - 要创建的节点的访问控制列表。zookeeper API提供了一个静态接口<strong>ZooDefs.Ids</strong> 来获取一些基本的acl列表。例如,Zoodefs.Ids.OPEN_ACL_USERAFE 返回发开znode的acl列表。</li><li><strong>createMode</strong> -节点的类型，这是一个枚举。</li><li><strong>callBack</strong> -异步回调接口</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">ACL</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">Id</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> papi
 * <span class="token keyword">@data</span> 2020/5/15
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//arg1：服务器和端口号</span>
            <span class="token comment">//arg2: 客户端和服务器之间的会话超时时间</span>
            <span class="token comment">//arg3: 监视器对象</span>
            <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.90.108:2181&quot;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>watchedEvent<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;连接成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//通知主线不要去等待了</span>
                        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//主线程阻塞等待连接对象</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取zookeeper的session会话编号</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zooKeeper<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop7&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hadoop7&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ZooDefs.Ids.READ_ACL_UNSAFE world:anyone:r</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop8&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">READ_ACL_UNSAFE</span><span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//world 模式</span>
            <span class="token comment">//权限列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Id</span> id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            id<span class="token punctuation">.</span><span class="token function">setScheme</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            id<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;anyone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ACL</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span><span class="token constant">READ</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ACL</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span><span class="token constant">WRITE</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop9&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop9&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//IP授权模式</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> acls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//授权模式和授权对象</span>
            <span class="token class-name">Id</span> id1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Id</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.60.130&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            acls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ACL</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> id1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop10&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop10&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acls<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//使用auth模式进行授权</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">addAuthInfo</span><span class="token punctuation">(</span><span class="token string">&quot;digest&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tyx:123&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop11&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop11&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">CREATOR_ALL_ACL</span><span class="token punctuation">,</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//使用auth模式进行授权，只读的模式</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">addAuthInfo</span><span class="token punctuation">(</span><span class="token string">&quot;digest&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tyx:123&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> acls2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Id</span> id2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Id</span><span class="token punctuation">(</span><span class="token string">&quot;auth&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tyx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            acls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ACL</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span><span class="token constant">READ</span><span class="token punctuation">,</span> id1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop12&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop12&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acls2<span class="token punctuation">,</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//使用digest模式进行授权</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> acls3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Id</span> id3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Id</span><span class="token punctuation">(</span><span class="token string">&quot;digest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tyx:adkalfjasncasaKJHG=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            acls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ACL</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> id3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop13&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop13&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acls3<span class="token punctuation">,</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//持久化有序节点</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop14&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop14&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">CREATOR_ALL_ACL</span><span class="token punctuation">,</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_SEQUENTIAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//临时节点</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop15&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop15&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">CREATOR_ALL_ACL</span><span class="token punctuation">,</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">EPHEMERAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//临时顺序节点</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop16&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop16&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">CREATOR_ALL_ACL</span><span class="token punctuation">,</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">EPHEMERAL_SEQUENTIAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//异步创建节点</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/hadoop16&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hadoop16&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">CREATOR_ALL_ACL</span><span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>StringCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">String</span> s1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//0代表创建成功</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//节点的路径</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//节点的路径</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//上下文参数</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;I am context&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-3-更新节点" tabindex="-1"><a class="header-anchor" href="#_5-3-更新节点" aria-hidden="true">#</a> 5.3 更新节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//同步方式
setData(String path,byte[] data, int version)
//异步方式
setData(String path, byte[] data, int version, AsyncCallback.StatCallback callBack, Object ctx)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>path</strong> -znode路径</li><li><strong>data</strong> -要存储在指定znode路径中的数据。</li><li><strong>version</strong> -znode的当前版本号。每当数据更改时，Zookeeper会更新znode的版本号。</li><li><strong>callBack</strong> -异步回调接口</li><li><strong>ctx</strong> 传递上下文参数</li></ul><h5 id="_5-4-删除节点" tabindex="-1"><a class="header-anchor" href="#_5-4-删除节点" aria-hidden="true">#</a> 5.4 删除节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//同步方式
delete(String path, int version)
//异步方式
delete(String path, int version, AsyncCallback.VoidCallback callBack, Object ctx)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>path</strong> -znode路径</li><li><strong>version</strong> -znode的当前版本</li><li><strong>callBack</strong> -异步回调接口</li><li><strong>ctx</strong> -传递上下文参数</li></ul><p>案例</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//arg1：删除节点的节点路径</span>
<span class="token comment">//arg2：数据版本信息 -1代表删除节点时不考虑节点版本信息</span>
zooKeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;/delete/node1&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span> callBack<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-5-查看节点" tabindex="-1"><a class="header-anchor" href="#_5-5-查看节点" aria-hidden="true">#</a> 5.5 查看节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//同步方式
getData(String path, boolean b, Stat stat)
//异步方式
getData(String path, boolean b, AsyncCallback.DataCallback callBack, Object ctx)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>path</strong> -znode路径</li><li><strong>b</strong> -是否使用连接对象中注册的监视器。</li><li><strong>stat</strong> -返回znode的元数据。</li><li><strong>callBack</strong> -异步回调接口</li><li><strong>ctx</strong> -传递上下文参数</li></ul><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092853606.png" alt="图 6" tabindex="0" loading="lazy"><figcaption>图 6</figcaption></figure><p>//异步方式获取</p><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092867326.png" alt="图 7" tabindex="0" loading="lazy"><figcaption>图 7</figcaption></figure><h5 id="_5-6-查看子节点" tabindex="-1"><a class="header-anchor" href="#_5-6-查看子节点" aria-hidden="true">#</a> 5.6 查看子节点</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>//同步方式
getChildren(String path, boolean b)
//异步方式
getChildren(String path, boolean b, AsyncCallback.ChildrenCallback callBack, Object ctx)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>path</strong> -Znode路径。</li><li><strong>b</strong> -是使用连接对象中注册的监视器。</li><li><strong>callBack</strong> -异步回调接口。</li><li><strong>ctx</strong> -传递上下文参数。</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//同步方式</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">&quot;/get&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//异步方式</span>
zookeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">&quot;/get&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>ChildrenCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span><span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> children<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//0代表读取成功</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//子节点路径</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//上下文参数对象</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//子节点信息</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> children<span class="token punctuation">)</span><span class="token punctuation">{</span>
    		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;I am Context&quot;</span><span class="token punctuation">)</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_6-7-检查节点是否存在" tabindex="-1"><a class="header-anchor" href="#_6-7-检查节点是否存在" aria-hidden="true">#</a> 6.7 检查节点是否存在</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//同步方法</span>
<span class="token function">exists</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//异步方法</span>
<span class="token function">exists</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">,</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>StatCallBack</span><span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>path</strong> -znode路径</li><li><strong>b</strong> -是否使用连接对象中注册的监视器</li><li><strong>callBack</strong> -异步回调接口</li><li><strong>ctx</strong> -上下文参数</li></ul><h4 id="六、zookeeper事件监听机制" tabindex="-1"><a class="header-anchor" href="#六、zookeeper事件监听机制" aria-hidden="true">#</a> 六、zookeeper事件监听机制</h4><h5 id="_6-1-watcher概念" tabindex="-1"><a class="header-anchor" href="#_6-1-watcher概念" aria-hidden="true">#</a> 6.1 watcher概念</h5><p>​ zookeeper提供了数据的发布/订阅功能，对个订阅者可同时监听某一特定主题对象，当该主题对象的自身状态发生变化时(例如节点内容改变，节点下的子节点列表改变等)，会实时，主动通知所有订阅者；</p><p>​ zookeeper采用了watcher机制实现数据的发布/订阅功能。该机制在被订阅对象发生变化时会异步通知客户端，因此客户端不必在Watcher注册后轮询阻塞，从而减轻了客户点压力。</p><p>​ watcher机制实际上与观察者密室类似，也可以看作是一种观察者密室在分布式场景下的实现方式。</p><h5 id="_6-2-wathcer架构" tabindex="-1"><a class="header-anchor" href="#_6-2-wathcer架构" aria-hidden="true">#</a> 6.2 wathcer架构</h5><p>​ Watcher实现由三个部分组成：</p><ul><li>Zookeeper服务端</li><li>Zookeeper客户端</li><li>客户端的ZKWatchManager对象</li></ul><p>​ 客户端首先将Watcher注册到服务端，同时将Watcher对象保存到客户端的Watch管理器中。当Zookeeper服务端监听的数据状态发生变化时，服务端会主动同时客户端，接着客户端的Watch管理器会触发相关Watcher来回调相应处理逻辑，从而完成整体的数据发布/订阅流程。</p><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092887505.png" alt="图 8" tabindex="0" loading="lazy"><figcaption>图 8</figcaption></figure><h5 id="_6-3-wahcher特性" tabindex="-1"><a class="header-anchor" href="#_6-3-wahcher特性" aria-hidden="true">#</a> 6.3 wahcher特性</h5><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>一次性</td><td>wathcer是一次性的，一旦被触发就会移除，再次使用时需要重新注册</td></tr><tr><td>客户端顺序回调</td><td>watcher回调是顺序串行化执行的，只有回调后客户端才能看到最新的数据状态。一个watcher回调逻辑不用太多，以免影响别的watcher执行</td></tr><tr><td>轻量级</td><td>wathcerEvent是最小的通信单元，结构上只包含通知状态，事件类型和节点路径，并不会告诉数据节点变化前后的具体内容；</td></tr><tr><td>时效性</td><td>watcher只有在当前session彻底失效时才会无效，若session有效期内快速重连成功。则wacher依然存在，然可接收到通知；</td></tr></tbody></table><h5 id="_6-4-watcher接口设计" tabindex="-1"><a class="header-anchor" href="#_6-4-watcher接口设计" aria-hidden="true">#</a> 6.4 watcher接口设计</h5><ul><li><strong>Wacher通知状态</strong></li></ul><p>​ KeeperState是客户端与服务daunt连接状态发生变化时对应的通知类型。路径为org.apache.zookeeper.Watcher.Event.KeeperState，是一个枚举类，其枚举属性如下：</p><table><thead><tr><th>枚举属性</th><th>说明</th></tr></thead><tbody><tr><td>SyncConnected</td><td>客户端与服务器正常连接时</td></tr><tr><td>Disconnected</td><td>客户端与服务器断开连接时</td></tr><tr><td>Expired</td><td>回话session失效时</td></tr><tr><td>AuthFailed</td><td>身份认证失败时</td></tr></tbody></table><ul><li><p><strong>Watcher事件类型(EventType)</strong></p><p>EventType是数据节点(znode)发生变化时对应的通知类型。EventType变化时KeeperState永远处于SyncConnected通知状态下；当KeeperState发生变化时，EventType永远为None。其路径为org.apache.zookeeper.Watcher.Event.EventType,是一个枚举类，枚举类属性如下：</p></li></ul><table><thead><tr><th>枚举属性</th><th>说明</th></tr></thead><tbody><tr><td>None</td><td>无</td></tr><tr><td>NodeCreated</td><td>Watcher监听的数据节点被创建时</td></tr><tr><td>NodeDeleted</td><td>Watcher监听的数据节点被删除时</td></tr><tr><td>NodeDataChanged</td><td>Watcher监听的数据节点内容发生变更时(无论内容数据是否变化)</td></tr><tr><td>NodeChildrenChanged</td><td>Watcher监听的数据节点的子节点列表发生变更时</td></tr></tbody></table><h5 id="_6-5-捕获相应的事件" tabindex="-1"><a class="header-anchor" href="#_6-5-捕获相应的事件" aria-hidden="true">#</a> 6.5 捕获相应的事件</h5><p>​ 上面讲到的zookeeper客户端连接的状态和zookeeper对znode节点监听的事件类型，下面我们来将如何建立zookeeper的watcher监听。在zookeeper中采用zk.getChildren(path,watch)、zk.exists(path,watch)，zk.getData(path,watcher,stat)这样的方式为某个znode注册监听。</p><p>下表以node-x节点为例，说明调用的注册方法和监听事件间的关系：</p><table><thead><tr><th>注册方式</th><th>Created</th><th>ChildrenChanged</th><th>Changed</th><th>Deleted</th></tr></thead><tbody><tr><td>zk.exists(&quot;/node-x&quot;,watcher)</td><td>可监控</td><td></td><td>可监控</td><td>可监控</td></tr><tr><td>zk.getData(&quot;/node-x&quot;,watcher)</td><td></td><td></td><td>可监控</td><td>可监控</td></tr><tr><td>zk.getChildren(&quot;/node-x&quot;,watcher)</td><td></td><td>可监控</td><td></td><td>可监控</td></tr></tbody></table><h5 id="_6-5-注册watcher的方法" tabindex="-1"><a class="header-anchor" href="#_6-5-注册watcher的方法" aria-hidden="true">#</a> 6.5 注册watcher的方法</h5><p><strong>客户端与服务器的连接状态</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>KeeperState : 通知状态
SyncConnected：客户端与服务器正常连接时
Disconnected:客户端与服务器断开连接时
Expired:回话session失效时
AuthFailed：身份认证失败时

事件类型为：None
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_6-6-查看节点" tabindex="-1"><a class="header-anchor" href="#_6-6-查看节点" aria-hidden="true">#</a> 6.6 查看节点</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//使用连接对象的监听器</span>
<span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">)</span>
<span class="token comment">//滴定仪监视器</span>
<span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">)</span>
<span class="token comment">//NodeDeleted：节点删除</span>
<span class="token comment">//NodeDataChanged:节点内容发生变化</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>path</strong> -znode路径。</li><li><strong>b</strong> -是否使用连接对象中注册的监听器。</li><li><strong>w</strong> -监视器对象。</li><li><strong>stat</strong> - 返回znode的元数据</li></ul><h4 id="七、配置中心案例" tabindex="-1"><a class="header-anchor" href="#七、配置中心案例" aria-hidden="true">#</a> 七、配置中心案例</h4><p>​ 工作中有这样一个场景：数据库用户名和密码信息放在一个配置文件中，应用读取该配置文件，配置文件信息放入缓存。</p><p>​ 若数据库的用户名和密码改变时候，还需要重新加载缓存，比较麻烦，通过Zookeeper可以轻松完成，当数据库发生变化时自动完成缓存同步。</p><p>设计思路：</p><ol><li>连接zookeeper服务器</li><li>读取zookeeper中的配置信息，注册watcher监听器，存入本地变量</li><li>当zookeeper中的配置信息发生变化时，通过watcher的回调方法捕获数据变化事件。</li><li>重新获取配置信息。</li></ol><h4 id="八、生成分布式唯一id" tabindex="-1"><a class="header-anchor" href="#八、生成分布式唯一id" aria-hidden="true">#</a> 八、生成分布式唯一ID</h4><p>​ 在过去的单库单表型系统中，通常可以使用数据库字段自带的auto_increment属性来自动为每条记录生成一个唯一的ID。但是分库分表后，就无法再依靠数据库的auto_increment属性唯一标识一条记录了。此时我们就可以用zookeeper在分布式环境下生成全局唯一ID。</p><p>设计思路：</p><ol><li>连接zookeeper服务器</li><li>指定路径下生成临时有序节点</li><li>取序号及为分布式环境下的唯一ID</li></ol><h4 id="九、分布式锁" tabindex="-1"><a class="header-anchor" href="#九、分布式锁" aria-hidden="true">#</a> 九、分布式锁</h4><p>​ 分布式锁有多重实现方式，比如通过数据库，redis都可以实现。作为分布式协同工具Zookeeper，当然也有者标准的实现方式。下面介绍在zookeeper中如何实现排它锁。</p><p>设计思路:</p><p>1、每个客户端往/Locks下创建临时有序节点/Locks/Lock_，创建成功后/Locks下面会有每个客户端对应的节点。如/Locks/Lock_0000001</p><p>2、客户端取得/Locks下子节点，并进行排序，判断排在最前面的是否为自己，如果自己的锁节点在第一位，代表获取锁成功。</p><p>3、如果自己的锁节点不在第一位，则监听自己前一位的锁节点。如果自己锁节点Lock_000002,那么则监听Lock_0000001</p><p>4、当前一位锁节点（Lock_000000001）对应的客户端执行完成，释放了锁，将会触发监听客户端（Lock_000002）的逻辑</p><p>5、监听客户端重新执行第2步逻辑，判断自己是否获得了锁；</p><h4 id="十、zookeeper集群搭建" tabindex="-1"><a class="header-anchor" href="#十、zookeeper集群搭建" aria-hidden="true">#</a> 十、zookeeper集群搭建</h4><p>​ 单机环境下，jdk、zookeeper安装完毕，基于一台虚拟机，进行zookeeper伪集群搭建，zookeeper集群中包含3个节点，节点对外提供服务端口号分别为2181,2182,2183</p><h5 id="_10-1配置zookeeper服务器文件" tabindex="-1"><a class="header-anchor" href="#_10-1配置zookeeper服务器文件" aria-hidden="true">#</a> 10.1配置zookeeper服务器文件</h5><p>​ 1、基于zookeeper-3.4.14复制三分zookeeper安装好的服务器文件，目录名称分别为zookeeper2181、zookeeper2182、zookeeper2183</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>cp -r zookeeper-3.4.14 zookeeper2181
cp -r zookeeper-3.4.14 zookeeper2182
cp -r zookeeper-3.4.14 zookeeper2183
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.修改zookeeper2181服务器对应配置文件</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>#服务器对应端口号
clientPort<span class="token operator">=</span><span class="token number">2181</span>
#数据快照文件所在路径
dataDir<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>zookeeper<span class="token operator">/</span>zookeeper2181<span class="token operator">/</span>data
#集群配置信息
	#<span class="token class-name"><span class="token namespace">server<span class="token punctuation">.</span></span>A</span><span class="token operator">=</span><span class="token class-name">B</span><span class="token operator">:</span><span class="token class-name">C</span><span class="token operator">:</span><span class="token class-name">D</span>
	#<span class="token class-name">A</span><span class="token operator">:</span>是一个数字，表示这个是服务器的编号
	#<span class="token class-name">B</span><span class="token operator">:</span>是这个服务器的ip地址
	#<span class="token class-name">C</span><span class="token operator">:</span><span class="token class-name">Zookeeper</span>服务器之间的通信端口号
	#<span class="token class-name">D</span><span class="token operator">:</span><span class="token class-name">Leader</span>选举的端口
server<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span><span class="token number">2287</span><span class="token operator">:</span><span class="token number">3387</span>
server<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span><span class="token number">2288</span><span class="token operator">:</span><span class="token number">3388</span>
server<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span><span class="token number">2289</span><span class="token operator">:</span><span class="token number">3389</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>在上一步dataDir指定的目录下，创建myid文件，然后在该文件添加上一步server配置对应A数字。</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>#zookeeper2181对应的数字为<span class="token number">1</span>
#<span class="token operator">/</span>home<span class="token operator">/</span>zookeeper<span class="token operator">/</span>zookeeper2181<span class="token operator">/</span>data目录下执行命令
echo <span class="token string">&quot;1&quot;</span> <span class="token operator">&gt;</span> myid
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.zookeeper2182 、zookeeper2183参照2，3不找进行相应配置</p><p>5.分别启动三台服务器，检验集群状态</p><p>​ 登录命令：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">.</span>/zkCli<span class="token punctuation">.</span>sh <span class="token operator">-</span>server <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span><span class="token number">2181</span>
<span class="token punctuation">.</span>/zkCli<span class="token punctuation">.</span>sh <span class="token operator">-</span>server <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span><span class="token number">2182</span>
<span class="token punctuation">.</span>/zkCli<span class="token punctuation">.</span>sh <span class="token operator">-</span>server <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span><span class="token number">2183</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-2-一致性协议-zab协议" tabindex="-1"><a class="header-anchor" href="#_10-2-一致性协议-zab协议" aria-hidden="true">#</a> 10.2 一致性协议：zab协议</h5><p>​ zab协议的全称是<strong>Zookeeper Atomic Broadcast</strong> (zookeeper原子广播)。zookeeper是通过zab协议来保证分布式事务的最终一致性</p><p>​ 基于zab协议，zookeeper集群中的角色主要有一下三类，如下表所示：</p><table><thead><tr><th>角色</th><th>描述</th></tr></thead><tbody><tr><td>领导者(leader)</td><td>领导者负责进行投票的发起和决议，更新系统状态</td></tr><tr><td>学习者(Learner)</td><td>Follower用于接受客户请求并向客户端返回结果，在选主过程中参与投票</td></tr><tr><td></td><td>ObServer可以接受客户端连接，将写请求转发给leader节点。但是ObServer不参加投票过程，只同步leader的状态。ObServer的目的是为了扩展系统，提高读取速度</td></tr><tr><td>客户端(Client)</td><td>请求发起方。</td></tr></tbody></table><p>zab广播模式工作原理，通过类似两阶段提交协议的方式解决数据一致性：</p><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092930200.png" alt="图 9" tabindex="0" loading="lazy"><figcaption>图 9</figcaption></figure><ol><li>leader从客户端收到一个写请求</li><li>leader生成一个新的事务并未这个事务生成一个唯一的ZXID</li><li>leader将这个事务提议(propose)发送给所有的follows节点</li><li>follower节点将收到的事务请求加入到历史队列(history queue)中，并发送ack给leader</li><li>当leader收到大多数follower(半数以上节点)的ack消息，leader会发送commit请求</li><li>当follower收到commit请求时，从历史队列中将事务请求commit</li></ol><h5 id="_10-3-zookeeper的leader选举" tabindex="-1"><a class="header-anchor" href="#_10-3-zookeeper的leader选举" aria-hidden="true">#</a> 10.3 zookeeper的leader选举</h5><p>​ <strong>1、服务器状态</strong></p><p>​ <strong>looking</strong>：寻找leader状态。当服务器处于该状态时，它会认为当前集群中没有leader,因此需要进入leader选举状态。</p><p>​ <strong>leading</strong>：领导者状态。表明当前服务器角色是leader。</p><pre><code>**following**：跟随者状态。表明当前服务器角色是follower。
</code></pre><p>​ <strong>observing</strong>：观察者状态。表明当前服务器角色是observer。</p><p><strong>2、服务器启动时期的leader选举</strong></p><p>​ 在集群初始化阶段，当有一台服务器server启动时，其单独无法进行完成leader选举，当第二太服务器server2启动时，此时两台机器可以相互通信，每台机器都视图zhaodaoleader。于是进入leader选举过程。选举过程如下：</p><ol><li>每个server发出一个投票。由于是初始情况，server1和server2都会将自己作为leader服务器进行投票，没投票会包含所推举的服务器的myid和zxid，使用(myid，zxid（<strong>事务ID</strong>）)来表示，此时server1的投票为(1,0),server2的投票为(2,0)，然后各自将这个投票发给集群中其他机器。</li><li>集群中的每一台服务器接受来自集群中各个服务器的投票。</li><li>处理投票。针对每一个投票，服务器都需要将别人的投票和自己的投票进行pk，pk规则如下 <ul><li>优先检查zxid(<strong>事务的编号</strong>)。zxid比较大的服务器优先为leader。</li><li>如果zxid相同，那么就比较myid(<strong>服务器的编号</strong>)。myid比较大的服务器作为leader服务器。</li></ul></li></ol><p>​ 对于Server1而言，它的投票是(1,0)，接受Server2的投票为(2,0)，首先会比较两者的zxid，均为0，在比较myid，此时server2的myid最大，于是更新自己的投票为(2,0)，然后重新投票，对于server2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次的投票信息即可。</p><pre><code>4.  统计投票。每次投票后，服务器都会统计投票信息，判断是否已经有过半机器接受到相同的投票信息，对于server1、server2而言，都统计出集群中已经有两台机器接受了(2,0)的投票信息，此时便认为已经选出了leader。
5.  改变服务状态。一旦确定了leader，每个服务器就会更新自己的状态，如果是follower，那么久变更为following，如果是leader，就变更为leading。
</code></pre><h5 id="_10-4-服务器运行时期的leader选举【zxid-事务id】" tabindex="-1"><a class="header-anchor" href="#_10-4-服务器运行时期的leader选举【zxid-事务id】" aria-hidden="true">#</a> 10.4 服务器运行时期的Leader选举【zxid：事务ID】</h5><p>​ 在zookeeper运行期间，leader与非leader服务器各司其职，即便当有非leader服务器宕机或新加入，此时也不会影响leader，但是一旦leader服务器挂了，那么这个集群将暂停对外服务，进入新一轮leader选举，其过程和启动时期的Leader选举过程基本一致。</p><p>​ 假设正在运行的server1、server2、server3三台服务器，当前leader是server2，若某一时刻leader挂了、此时开始Leader选举。选举过程如下：</p><ol><li>变更状态。leader挂后，剩余的服务器都会将自己的服务状态变更为looking，然后开始进入leader选举过程。</li><li>每个server会发出一个投票。在运行期间，每个服务器上的zxid可能不同，此时嘉定server1的ZXID为122，server3的zxid为122,在第一轮投票中，server1和server3都会投自己、产生投票(1,122)，(3,122)，然后各自将投票发送给集群中的所有机器。</li><li>接受来自各个服务器的投票。与启动时过程相同。</li><li>处理投票。与启动时过程相同，此时，server3将会成为leader。</li><li>统计投票。与启动时过程相同。</li><li>改变服务器的状态。与启动时过程相同。</li></ol><h5 id="_10-5-observer角色及其配置" tabindex="-1"><a class="header-anchor" href="#_10-5-observer角色及其配置" aria-hidden="true">#</a> 10.5 observer角色及其配置</h5><p>​ observer角色特点：</p><ol><li><p>不参与集群的leader选举</p></li><li><p>不参与集群中写数据时的ack反馈</p><p>为了使用observer角色，在任何想变成observer角色的配置文件中加入如下配置：</p></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>peerType<span class="token operator">=</span>observer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>​ 并在所有的server的配置文件中，配置成observer模式的server的哪行配置追加：observer，例如：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>server<span class="token punctuation">.</span><span class="token number">3</span><span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.130</span><span class="token operator">:</span><span class="token number">2289</span><span class="token operator">:</span><span class="token number">3389</span><span class="token operator">:</span>observer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_10-6-zookeeperapi连接集群" tabindex="-1"><a class="header-anchor" href="#_10-6-zookeeperapi连接集群" aria-hidden="true">#</a> 10.6 zookeeperAPI连接集群</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Zookeeper</span><span class="token punctuation">(</span><span class="token class-name">String</span> connectionString<span class="token punctuation">,</span> <span class="token keyword">int</span> sessionTimeout<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>**connectionString ** -zooKeeper集合主机</li><li><strong>sessionTimeout</strong> - 回话超时(以毫秒为单位)。</li><li><strong>watcher</strong> - 实现“监视器”界面的对象。Zookeeper集合通过监视器对象返回连接状态。</li></ul><h4 id="十一、zookeeper开源客户端curator介绍" tabindex="-1"><a class="header-anchor" href="#十一、zookeeper开源客户端curator介绍" aria-hidden="true">#</a> 十一、zookeeper开源客户端curator介绍</h4><ul><li>zookeeper开源客户端curator介绍</li><li>zookeeper四字监控命令</li><li>zookeeper图形化的客户端工具(Zoolnspector)</li><li>taokeeper监控工具的使用</li></ul><h5 id="_11-1-curator简介" tabindex="-1"><a class="header-anchor" href="#_11-1-curator简介" aria-hidden="true">#</a> 11.1 curator简介</h5><p>​ curator是Netflix公司开源的一个zookeeper客户端，后捐赠给apache，curator框架在走哦科普日原生API接口上进行了包装，解决了很多zookeeper客户端非底层的细节开发。提供了zookeeper各种应用场景(比如：分布式锁服务，集群领导选举，共享计数器，缓存机制，分布式队列等)的抽象封装，实现了Fluent风格的API接口，是最好用，最流行的zookeeper的客户端。</p><p>​ 原生zookeeperAPI的不足：</p><ul><li><p>连接对象异步创建，需要开发人员自行编码等待。</p></li><li><p>连接没有自动重连超时机制</p></li><li><p>watcher一次注册生效一次</p></li><li><p>不支持递归创建树形节点</p><p>curator特点：</p></li><li><p>解决session会话超时重连</p></li><li><p>watche反复注册</p></li><li><p>简化开发api</p></li><li><p>遵循Fluent风格的API</p></li><li><p>提供了分布式锁服务，共享计数器，缓存机制等机制</p></li></ul><h5 id="_11-2-zookeeoer-四字监控命令" tabindex="-1"><a class="header-anchor" href="#_11-2-zookeeoer-四字监控命令" aria-hidden="true">#</a> 11.2 zookeeoer 四字监控命令</h5><p>​ zookeeper支持某些特定的四字命令与其他的交互。他们大多数是查询命令，用来获取zookeeper服务的当前状态及相关的信息。用户在客户点可以通过telnet或nc向zookeeper提交相应的命令。走哦可额偶尔常用的四字命令见下表：</p><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>conf</td><td>输出相关服务的配置的详细信息。比如端口，zk数据及日志配置路径，最大连接数，session超时时间，serverid等。</td></tr><tr><td>cons</td><td>列出所有连接到台服务器的客户端连接/回话的详细信息。包括“接受/发送”的包数量、session id。操作延迟，最后的操作执行等信息。</td></tr><tr><td>crst</td><td>重置当前这台服务器所有连接/回话的统计信息</td></tr><tr><td>envi</td><td>输出关于服务器的环境详细信息</td></tr><tr><td>ruok</td><td>测试服务器的详细信息：接受/发送包数量、连接数、模式(leader/follower)、节点总数、延迟、所有客户端的列表。</td></tr><tr><td>srst</td><td>重置server状态</td></tr><tr><td>wchs</td><td>累出服务器watches的简洁信息：连接总数、watching节点总数和watches总数</td></tr><tr><td>wchc</td><td>通过session分组，累出watch的所有节点，它的输出是一个与watch相关的回话的节点列表</td></tr><tr><td>mntr</td><td>雷虎集群的健康状态。包括“接受/发送”的包数量，操作延迟，当前服务模式(leader/follower)、节点总数，watch总数，临时节点总数</td></tr></tbody></table><h5 id="_11-3-conf-命令" tabindex="-1"><a class="header-anchor" href="#_11-3-conf-命令" aria-hidden="true">#</a> 11.3 conf 命令</h5><p>​ conf：输出相关服务配置的详细信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>shell终端输入：echo conf <span class="token operator">|</span> nc localhost <span class="token number">2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>clientPort</td><td>客户端端口号</td></tr><tr><td>dataDir</td><td>数据快照文件目录 默认情况下100000次事务操作生成一次快照</td></tr><tr><td>dataLogDir</td><td>事务日志文件目录，生产环境中放在独立的磁盘上</td></tr><tr><td>tickTime</td><td>服务器之间或客户端与服务器至今维持心跳的时间间隔(以毫秒为单位)</td></tr><tr><td>maxClientCnxns</td><td>最大连接数</td></tr><tr><td>minSessionTimeout</td><td>最小session超时minSessionTimeout=tickTime*2</td></tr><tr><td>maxSessionTimeout</td><td>最大session超时maxSessionTimeout=tickTime*20</td></tr><tr><td>serverId</td><td>服务器编号</td></tr><tr><td>initLimit</td><td>集群中的follower服务器(F)与leader服务器(L)之间初始连接时能容忍的最多心跳数</td></tr><tr><td>syncLimit</td><td>集群中的follower服务器(F)与leader服务器(L)之间请求和答应之间能容忍的最多心跳数</td></tr><tr><td>electionAlg</td><td>0:基于UDP的LeaderElection 1：基于UDP的FastLeaderElection 2：基于UDP和认证的FastLeaderElection 3：基于TCP的FastLeaderElection 在3.4.10版本中，默认值为3，另外的三种算法已经被弃用了，并且有计划在之后的版本中将它们彻底铲除而不再支持。</td></tr><tr><td>electionPort</td><td>选举端口</td></tr><tr><td>quorumPort</td><td>数据通信端口</td></tr><tr><td>peerType</td><td>是否为观察者 1 为观察者</td></tr></tbody></table><h5 id="_11-4-cons命令" tabindex="-1"><a class="header-anchor" href="#_11-4-cons命令" aria-hidden="true">#</a> 11.4 cons命令</h5><p>cons：列出所有连接到这台服务器的客户端连接/回话的详细信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>echo cons <span class="token operator">|</span> nc localhost <span class="token number">2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>ip</td><td>IP地址</td></tr><tr><td>port</td><td>端口号</td></tr><tr><td>queued</td><td>等待被处理的请求数，请求缓存在队列中</td></tr><tr><td>received</td><td>收到的包数</td></tr><tr><td>sent</td><td>发送的包数</td></tr><tr><td>sid</td><td>回话id</td></tr><tr><td>lop</td><td>最后的操作GETD-读取数据DELE-删除CREA-创建数据</td></tr><tr><td>est</td><td>连接时间戳</td></tr><tr><td>to</td><td>超时时间</td></tr><tr><td>lcxid</td><td>当前回话的操作id</td></tr><tr><td>lzxid</td><td>最大事务id</td></tr><tr><td>llat</td><td>最后/最新 延时</td></tr><tr><td>minlat</td><td>最小延时</td></tr><tr><td>maxlat</td><td>最大延时</td></tr><tr><td>avglat</td><td>平均延时</td></tr></tbody></table><h5 id="_11-5-crst命令" tabindex="-1"><a class="header-anchor" href="#_11-5-crst命令" aria-hidden="true">#</a> 11.5 crst命令</h5><p>crst：重置当前这台服务器所有连接/绘画的统计信息</p><p>shell终端输入：echo crest | nc localhost 2181</p><h5 id="_11-6-dump命令" tabindex="-1"><a class="header-anchor" href="#_11-6-dump命令" aria-hidden="true">#</a> 11.6 dump命令</h5><p>dump：列出未经处理的回话和临时节点</p><p>shell终端输入：echo dump | nc loalhost 21</p><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>session id</td><td>znode path(1对多，处于队列中排队的session和临时节点)</td></tr></tbody></table><h5 id="_11-7-eniv命令" tabindex="-1"><a class="header-anchor" href="#_11-7-eniv命令" aria-hidden="true">#</a> 11.7 eniv命令</h5><p>envi：输出关于服务器的环境详细信息</p><p>shell终端输入：echo envi |nc localhost 2181</p><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>zookeeper.version</td><td>版本</td></tr><tr><td><a href="http://host.name" target="_blank" rel="noopener noreferrer">host.name<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></td><td>host信息</td></tr><tr><td>java.version</td><td>java版本</td></tr><tr><td>java.vendor</td><td>供应商</td></tr><tr><td>java.home</td><td>运行环境所在目录</td></tr><tr><td>java.class.path</td><td>classpath</td></tr><tr><td>java.library.path</td><td>第三方库指定非java类包的位置(如：dll，so)</td></tr><tr><td>java.io.tmpdir</td><td>默认的临时文件路径</td></tr><tr><td>java.compiler</td><td>JIL编译器的名称</td></tr><tr><td><a href="http://os.name" target="_blank" rel="noopener noreferrer">os.name<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></td><td>Linux</td></tr><tr><td>os.arch</td><td>amd64</td></tr><tr><td>os.version</td><td>XXXXXXX</td></tr><tr><td><a href="http://user.name" target="_blank" rel="noopener noreferrer">user.name<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></td><td>zookeeper</td></tr><tr><td>user.home</td><td>/home/zookeeper</td></tr><tr><td>user.dir</td><td>/home/zookeeper/zookeeper2181/bin</td></tr></tbody></table><h5 id="_11-8-ruok命令" tabindex="-1"><a class="header-anchor" href="#_11-8-ruok命令" aria-hidden="true">#</a> 11.8 ruok命令</h5><p>ruok：测试服务是否处于正确运行状态</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>echo ruok <span class="token operator">|</span> nv <span class="token number">192.168</span><span class="token number">.60</span><span class="token number">.120</span> <span class="token number">2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://cdn.liuhongjiao.cn/images/2023/04/10/2-zk-overview/1681092954392.png" alt="图 10" tabindex="0" loading="lazy"><figcaption>图 10</figcaption></figure><h5 id="_11-9-stat命令" tabindex="-1"><a class="header-anchor" href="#_11-9-stat命令" aria-hidden="true">#</a> 11.9 stat命令</h5><p>stat：输出服务器的详细信息与srvr相似，但是多了每个连接的回话信息</p><p>shell终端输入：echo stat | nc localhost 2181</p><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>Zookeeper version</td><td>版本</td></tr><tr><td>Latency min/avg/max</td><td>延时</td></tr><tr><td>Received</td><td>收包</td></tr><tr><td>Sent</td><td>发包</td></tr><tr><td>Connections</td><td>连接数</td></tr><tr><td>OutStanding</td><td>堆积数</td></tr><tr><td>Zxid</td><td>最大事务id</td></tr><tr><td>Mode</td><td>服务器角色</td></tr><tr><td>Node count</td><td>节点数</td></tr></tbody></table><h5 id="_11-10-srst命令" tabindex="-1"><a class="header-anchor" href="#_11-10-srst命令" aria-hidden="true">#</a> 11.10 srst命令</h5><p>srst：重置server状态</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>shell终端输入：schoolsrst | nc localhost 2181
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_11-11-wchs命令" tabindex="-1"><a class="header-anchor" href="#_11-11-wchs命令" aria-hidden="true">#</a> 11.11 wchs命令</h5><p>wchs：累出服务器watches的简洁信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>shell终端输入：echo wchs <span class="token operator">|</span> nc localhost <span class="token number">2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>connectsions</td><td>连接数</td></tr><tr><td>watch-paths</td><td>watch节点数</td></tr><tr><td>watchers</td><td>watcher数量</td></tr></tbody></table><h5 id="_11-12-wchc命令" tabindex="-1"><a class="header-anchor" href="#_11-12-wchc命令" aria-hidden="true">#</a> 11.12 wchc命令</h5><p>wchc：通过session分组，累出watch的所有节点，它的输出的是一个与watch相关的回话的节点列表问题：</p><p>问题：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>wchc is not executed because it is not in the whiltelist
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>解决方法：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>#修改启动指令 zkServer.sh
#注意找到这个信息
else
  echo &quot;JMX disabled by user request&quot; &gt; &amp; 2
  ZOOMAIN = &quot;org.apache.zookeeper.server.quorum.QuorumPeerMain&quot;
fi

# 添加如下信息
ZOOMAIN = &quot;-Dzookeeper.4lw.commands.whitelist=*${ZOOMAIN}&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>shell终端输入：echo wchc | nc localhost 2181</p><h5 id="_11-13-wchp命令" tabindex="-1"><a class="header-anchor" href="#_11-13-wchp命令" aria-hidden="true">#</a> 11.13 wchp命令</h5><p>查看服务上有多少个节点；</p><p>wchp：通过路径分组，列出所有的watch的session id信息</p><p>问题：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>wchp is not executer beacues it is not in the whitelist
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>解决方法：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
#修改启动指令 zkServer.sh
#注意找到这个信息
else
  echo &quot;JMX disabled by user request&quot; &gt; &amp; 2
  ZOOMAIN = &quot;org.apache.zookeeper.server.quorum.QuorumPeerMain&quot;
fi

# 添加如下信息
ZOOMAIN = &quot;-Dzookeeper.4lw.commands.whitelist=*${ZOOMAIN}&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>shell终端输入：echo wchp | nc localhost 2181</p><h5 id="_11-14-mntr命令" tabindex="-1"><a class="header-anchor" href="#_11-14-mntr命令" aria-hidden="true">#</a> 11.14 mntr命令</h5><p>mntr：猎虎服务器的健康状态</p><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>zk_version</td><td>版本</td></tr><tr><td>zk_avg_latency</td><td>平均延时</td></tr><tr><td>zk_max_latency</td><td>最大延时</td></tr><tr><td>zk_min_latency</td><td>最小延时</td></tr><tr><td>zk_packets_received</td><td>收包数</td></tr><tr><td>zk_num_alive_connections</td><td>连接数</td></tr><tr><td>zk_outstanding_requests</td><td>堆积请求数</td></tr><tr><td>zk_znode_count</td><td>znode数量</td></tr><tr><td>zk_watch_count</td><td>watch数量</td></tr><tr><td>zk_ephemreals_count</td><td>临时节点</td></tr><tr><td>zk_approximate_data_size</td><td>数据大小</td></tr><tr><td>zk_open_file_decriptor_count</td><td>打开的文件描述符数量</td></tr><tr><td>zk_max_file_descriptor_count</td><td>最大文件描述数量</td></tr><tr><td>zk_server_state</td><td>leader/follower数量</td></tr></tbody></table><p>shell终端输入：echo mntr | nc localhost 2181</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/master/docs/study/enterprise/zk/2-zk-overview.md" rel="noopener noreferrer" target="_blank" aria-label="在GitHub上编辑" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在GitHub上编辑<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: liuhongjiao@koolearn.com">liuhongjiao</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/study/enterprise/zk/1-install-in-mac.html" class="nav-link prev" aria-label="1-Mac安装"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><span class="font-icon icon iconfont icon-edit" style=""></span>1-Mac安装</div></a><!----></nav><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><div style="width:600px;margin:0 auto; padding:20px 0;"><a target="_blank" href="https://beian.miit.gov.cn/"  style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">冀ICP备2023002189号-1</p></a><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11011402013606" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="/beian_icon.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">京公网安备 11011402013606号</p></a></div></div><div class="copyright">Copyright © 2023 哇哩哇哩哇</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-5f172635.js" defer></script>
  </body>
</html>
